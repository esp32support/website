<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Purchase Add-On - ESP32 CAN Sniffer</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='20' y='20' width='60' height='60' fill='%237dd3fc' stroke='%23bae6fd' stroke-width='2' rx='4'/%3E%3Crect x='25' y='25' width='50' height='50' fill='%23080a10'/%3E%3Ccircle cx='20' cy='35' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='20' cy='50' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='20' cy='65' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='80' cy='35' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='80' cy='50' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='80' cy='65' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='35' cy='20' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='50' cy='20' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='65' cy='20' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='35' cy='80' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='50' cy='80' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='65' cy='80' r='2' fill='%237dd3fc'/%3E%3C/svg%3E" />
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='20' y='20' width='60' height='60' fill='%237dd3fc' stroke='%23bae6fd' stroke-width='2' rx='4'/%3E%3Crect x='25' y='25' width='50' height='50' fill='%23080a10'/%3E%3Ccircle cx='20' cy='35' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='20' cy='50' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='20' cy='65' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='80' cy='35' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='80' cy='50' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='80' cy='65' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='35' cy='20' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='50' cy='20' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='65' cy='20' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='35' cy='80' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='50' cy='80' r='2' fill='%237dd3fc'/%3E%3Ccircle cx='65' cy='80' r='2' fill='%237dd3fc'/%3E%3C/svg%3E" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="cookie-consent.css" />
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Google Analytics - Only loads if user accepts cookies -->
    <script>
        window.gaId = 'G-6KFL6RX1SM'; // âœ… Google Analytics ID
    </script>
    <style>
        .purchase-container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            background: rgba(8, 10, 16, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(125, 211, 252, 0.2);
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #e5e9f0;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(8, 10, 16, 0.8);
            border: 1px solid rgba(125, 211, 252, 0.3);
            border-radius: 4px;
            color: #e5e9f0;
            font-size: 1rem;
            font-family: monospace;
        }
        .form-group input:focus {
            outline: none;
            border-color: #7dd3fc;
            box-shadow: 0 0 0 2px rgba(125, 211, 252, 0.2);
        }
        .addon-info-box {
            background: rgba(125, 211, 252, 0.15);
            border: 2px solid rgba(125, 211, 252, 0.4);
            border-radius: 4px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .addon-info-box h3 {
            color: #7dd3fc;
            margin-top: 0;
            margin-bottom: 1rem;
        }
        .addon-info-box ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
            color: #cbd5f5;
        }
        .addon-info-box .price {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00AA00;
            margin: 1rem 0;
        }
        .btn-purchase {
            width: 100%;
            padding: 1rem;
            background: #00AA00;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 1rem;
        }
        .btn-purchase:hover {
            background: #008800;
        }
        .btn-purchase:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .error-message {
            color: #ff6b6b;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        .success-message {
            color: #00AA00;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        .info-box {
            background: rgba(125, 211, 252, 0.1);
            border: 1px solid rgba(125, 211, 252, 0.3);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: #cbd5f5;
        }
        .license-verification {
            background: rgba(125, 211, 252, 0.1);
            border: 1px solid rgba(125, 211, 252, 0.3);
            border-radius: 4px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .license-verification.verified {
            background: rgba(0, 170, 0, 0.1);
            border-color: rgba(0, 170, 0, 0.3);
        }
        .license-verification.error {
            background: rgba(255, 107, 107, 0.1);
            border-color: rgba(255, 107, 107, 0.3);
        }
    </style>
</head>
<body>
    <header class="hero" style="min-height: auto; padding: 1rem 0;">
        <div class="container">
            <nav class="nav">
                <span class="logo">ESP32 CAN BUS Sniffer</span>
                <div class="nav-links">
                    <a href="index.html">Home</a>
                    <a href="purchase.html">Purchase License</a>
                </div>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="purchase-container">
            <h1 style="color: #e5e9f0; margin-bottom: 1rem;">Purchase Add-On</h1>
            
            <div class="addon-info-box">
                <h3>ðŸ”§ Fiat Dictionary Add-On</h3>
                <p style="color: #cbd5f5; margin: 0.5rem 0;">
                    Unlock specialized Fiat CAN message decoding capabilities for your existing PRO license.
                </p>
                <ul>
                    <li>Fiat-specific byte addressing support</li>
                    <li>Fiat PID detection and decoding</li>
                    <li>Auto-learning for Fiat signals</li>
                    <li>Hardware-bound encryption (tied to your license)</li>
                    <li>Lifetime access (one-time purchase)</li>
                </ul>
                <div class="price">â‚¬30 (one-time purchase)</div>
            </div>

            <div class="info-box">
                <strong>Important:</strong> You must have an active PRO license to purchase this add-on. 
                After payment, you will receive the <strong>dictionary files</strong> via email in a zip file. Simply extract the files and place them in your ESP32 CAN Sniffer installation directory. 
                Extract the files to your application directory to use the add-on.
            </div>

            <form id="addonPurchaseForm">
                <div class="form-group">
                    <label for="email">Email Address (used for license) *</label>
                    <input type="email" id="email" name="email" required 
                           placeholder="your.email@example.com" />
                    <div class="error-message" id="emailError"></div>
                </div>

                <div class="form-group">
                    <label for="licenseKey">License Key *</label>
                    <input type="text" id="licenseKey" name="licenseKey" required 
                           placeholder="B61D-8A50-0081-850E-E956-C3F4-12F4-9034 (or without dashes)" 
                           style="font-family: monospace; letter-spacing: 0.5px;" />
                    <div style="font-size: 0.85rem; color: #cbd5f5; margin-top: 0.25rem;">
                        You can enter your license key with or without dashes. Both formats are accepted.
                    </div>
                    <div class="error-message" id="licenseKeyError"></div>
                </div>


                <div class="form-group" style="margin-top: 1.5rem;">
                    <label style="display: flex; align-items: flex-start; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" id="termsCheckbox" name="termsCheckbox" required 
                               style="width: auto; margin-right: 0.75rem; margin-top: 0.25rem; cursor: pointer;" />
                        <span>I agree to the <a href="docs/terms.html" target="_blank" style="color: #7dd3fc; text-decoration: underline;">Terms & Refund Policy</a> and <a href="privacy.html" target="_blank" style="color: #7dd3fc; text-decoration: underline;">Privacy Policy</a> *</span>
                    </label>
                    <div class="error-message" id="termsError"></div>
                </div>

                <button type="submit" class="btn-purchase" id="purchaseBtn" disabled>
                    Proceed to Payment (â‚¬30)
                </button>

                <div class="error-message" id="formError"></div>
                <div class="success-message" id="formSuccess"></div>
            </form>
        </div>
    </div>

    <script>
        // API endpoints
        // âš ï¸ IMPORTANT: Update this URL to your deployed API server
        const PRODUCTION_API_URL = 'https://esp32-promo-api.onrender.com'; // âœ… Production API URL
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:5000'
            : PRODUCTION_API_URL;
        const VERIFY_LICENSE_API = API_BASE_URL + '/api/verify-license';
        const SAVE_ADDON_PURCHASE_API = API_BASE_URL + '/api/save-addon-purchase';
        const API_HEALTH_CHECK = API_BASE_URL + '/api/health';
        
        // Test API connection on page load (for debugging)
        async function testApiConnection() {
            try {
                console.log('Testing API connection to:', API_BASE_URL);
                const response = await fetch(API_HEALTH_CHECK, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'},
                    // Add timeout
                    signal: AbortSignal.timeout(5000)
                });
                if (response.ok) {
                    const data = await response.json();
                    console.log('API connection: OK', data);
                } else {
                    console.warn('API health check failed:', response.status, response.statusText);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.error('API connection timeout - server may be slow or unreachable');
                } else {
                    console.error('API connection test failed:', error.message);
                    console.error('API URL:', API_BASE_URL);
                    console.error('This usually means:');
                    console.error('  1. API server is not deployed');
                    console.error('  2. API server is down');
                    console.error('  3. Wrong API URL');
                    console.error('  4. CORS issue (check API CORS configuration)');
                }
            }
        }
        
        // Test connection when page loads (only log to console, don't show to user)
        if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
            testApiConnection();
        }
        
        // Stripe Payment Link for Fiat Dictionary Add-On (â‚¬30)
        // âš ï¸ TEST LINK - Replace with production link when ready
        const STRIPE_ADDON_PAYMENT_LINK = 'https://buy.stripe.com/test_8x228rcZ3b835RKc9KeUU02';  // âœ… Test link configured
        
        // Auto-format license key as user types (optional - adds dashes for readability)
        document.getElementById('licenseKey').addEventListener('input', function() {
            let value = this.value.replace(/[^A-Z0-9]/gi, '').toUpperCase(); // Remove non-alphanumeric, uppercase
            if (value.length > 32) {
                value = value.substring(0, 32);
            }
            // Optionally format with dashes (but don't force it - user can type either way)
            // We'll normalize on the server side anyway
            this.value = value;
            checkFormValidity();
        });
        
        // Enable/disable purchase button based on form validity
        function checkFormValidity() {
            const email = document.getElementById('email').value.trim();
            const licenseKey = document.getElementById('licenseKey').value.trim().replace(/[^A-Z0-9]/gi, '').toUpperCase();
            const termsAccepted = document.getElementById('termsCheckbox').checked;
            
            // Clear previous errors
            document.getElementById('licenseKeyError').textContent = '';
            document.getElementById('emailError').textContent = '';
            
            // Check email
            if (!email || !email.includes('@')) {
                document.getElementById('purchaseBtn').disabled = true;
                return;
            }
            
            // Check license key format (must be 32 characters)
            if (!licenseKey || licenseKey.length !== 32) {
                document.getElementById('purchaseBtn').disabled = true;
                return;
            }
            
            // Check terms
            if (!termsAccepted) {
                document.getElementById('purchaseBtn').disabled = true;
                return;
            }
            
            // All valid - enable button
            document.getElementById('purchaseBtn').disabled = false;
        }
        
        // Check form validity on email change
        document.getElementById('email').addEventListener('input', checkFormValidity);
        document.getElementById('email').addEventListener('blur', function() {
            const email = this.value.trim();
            if (email && !email.includes('@')) {
                document.getElementById('emailError').textContent = 'Please enter a valid email address';
            } else {
                document.getElementById('emailError').textContent = '';
            }
            checkFormValidity();
        });
        
        // Check form validity on license key change
        document.getElementById('licenseKey').addEventListener('blur', function() {
            let licenseKey = this.value.trim().replace(/[^A-Z0-9]/gi, '').toUpperCase();
            
            if (licenseKey.length !== 32) {
                document.getElementById('licenseKeyError').textContent = 'License key must be 32 characters (dashes/spaces are optional)';
            } else {
                document.getElementById('licenseKeyError').textContent = '';
            }
            
            checkFormValidity();
        });
        
        // Check form validity on terms checkbox change
        document.getElementById('termsCheckbox').addEventListener('change', checkFormValidity);

        document.getElementById('addonPurchaseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            let licenseKey = document.getElementById('licenseKey').value.trim();
            // Normalize license key (remove dashes, spaces, uppercase)
            licenseKey = licenseKey.replace(/[^A-Z0-9]/gi, '').toUpperCase();
            const termsAccepted = document.getElementById('termsCheckbox').checked;
            
            // Clear previous errors
            document.getElementById('emailError').textContent = '';
            document.getElementById('licenseKeyError').textContent = '';
            document.getElementById('termsError').textContent = '';
            document.getElementById('formError').textContent = '';
            document.getElementById('formSuccess').textContent = '';
            
            // Validate
            if (!email || !email.includes('@')) {
                document.getElementById('emailError').textContent = 'Please enter a valid email address';
                return;
            }
            
            // Normalize license key
            const normalizedKey = licenseKey.replace(/[^A-Z0-9]/gi, '').toUpperCase();
            
            if (!normalizedKey || normalizedKey.length !== 32) {
                document.getElementById('licenseKeyError').textContent = 'License key must be 32 characters (dashes/spaces are optional)';
                return;
            }
            
            if (!termsAccepted) {
                document.getElementById('termsError').textContent = 'You must agree to the Terms & Refund Policy and Privacy Policy to proceed';
                return;
            }
            
            // Save purchase info to server and generate activation code
            document.getElementById('purchaseBtn').disabled = true;
            document.getElementById('purchaseBtn').textContent = 'Processing Purchase...';
            document.getElementById('formError').textContent = '';
            document.getElementById('formSuccess').textContent = '';
            
            try {
                const saveResponse = await fetch(SAVE_ADDON_PURCHASE_API, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: email,
                        license_key: normalizedKey, // Send normalized version
                        addon_type: 'fiat_dictionary',
                        price: 30
                    })
                });
                
                const result = await saveResponse.json();
                
                if (saveResponse.ok && result.success) {
                    // Success - payment logged, files will be sent manually
                    document.getElementById('formSuccess').textContent = 
                        'âœ“ Payment successful! You will receive the dictionary files via email shortly. ' +
                        'The files will be sent as a zip file - simply extract and place them in your ESP32 CAN Sniffer directory.';
                    document.getElementById('purchaseBtn').textContent = 'Payment Complete';
                    document.getElementById('purchaseBtn').disabled = true;
                    
                    // Clear form
                    document.getElementById('email').value = '';
                    document.getElementById('licenseKey').value = '';
                    document.getElementById('termsCheckbox').checked = false;
                    
                    // Store in sessionStorage for reference
                    sessionStorage.setItem('addon_purchase_email', email);
                    sessionStorage.setItem('addon_purchase_license_key', licenseKey);
                    
                } else if (saveResponse.status === 404) {
                    // API endpoint not found - service may not be deployed or is sleeping
                    document.getElementById('formError').textContent = 
                        'API server is not available. The service may be sleeping or not deployed. ' +
                        'Please contact support at esp32contact@gmail.com or try again in a few moments.';
                    document.getElementById('purchaseBtn').disabled = false;
                    document.getElementById('purchaseBtn').textContent = 'Proceed to Payment (â‚¬30)';
                } else {
                    // Error from server
                    document.getElementById('formError').textContent = 
                        result.error || 'Failed to process purchase. Please try again or contact support at esp32contact@gmail.com';
                    document.getElementById('purchaseBtn').disabled = false;
                    document.getElementById('purchaseBtn').textContent = 'Proceed to Payment (â‚¬30)';
                }
            } catch (e) {
                console.error('Purchase error:', e);
                console.error('API URL:', SAVE_ADDON_PURCHASE_API);
                let errorMsg = 'Failed to process purchase. ';
                if (e.name === 'TypeError' && e.message.includes('fetch')) {
                    errorMsg += 'Cannot connect to server. Please check your internet connection.';
                } else {
                    errorMsg += 'Please try again or contact support at esp32contact@gmail.com';
                }
                document.getElementById('formError').textContent = errorMsg;
                document.getElementById('purchaseBtn').disabled = false;
                document.getElementById('purchaseBtn').textContent = 'Proceed to Payment (â‚¬30)';
            }
        });
    </script>
    
    <!-- Cookie Consent (GDPR Compliant) -->
    <script src="cookie-consent.js"></script>
</body>
</html>

